<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Do Your Chores, Bruh</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.svg">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Chores">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="config.js" onerror="window.CONFIG_MISSING=true"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; }
    @keyframes choreComplete {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.02); opacity: 0.8; }
      100% { transform: scale(0.95); opacity: 0; }
    }
    @keyframes checkmark {
      0% { transform: scale(0) rotate(-45deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .chore-completing {
      animation: choreComplete 0.4s ease-out forwards;
      pointer-events: none;
    }
    .checkmark-animation {
      animation: checkmark 0.3s ease-out forwards;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Check if config.js is loaded
    if (typeof CONFIG === 'undefined' || window.CONFIG_MISSING) {
      const root = document.getElementById('root');
      root.innerHTML = `
        <div style="font-family: 'Segoe UI', system-ui, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; text-align: center;">
          <h1 style="color: #FF6B6B; margin-bottom: 20px;">Configuration Missing</h1>
          <p style="color: #666; margin-bottom: 20px;">
            The app needs a <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">config.js</code> file to run.
          </p>
          <div style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; text-align: left;">
            <p style="margin-bottom: 10px;"><strong>To set up:</strong></p>
            <ol style="color: #555; line-height: 1.8; padding-left: 20px;">
              <li>Copy <code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">config.example.js</code> to <code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">config.js</code></li>
              <li>Edit <code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">config.js</code> with your Supabase credentials</li>
              <li>Refresh this page</li>
            </ol>
          </div>
          <p style="color: #999; margin-top: 20px; font-size: 14px;">
            See <a href="config.example.js" style="color: #45B7D1;">config.example.js</a> for the template.
          </p>
        </div>
      `;
      throw new Error('config.js not found - see instructions above');
    }

    // Load configuration from external config.js
    const DEFAULT_USERS = CONFIG.defaultUsers;
    const EMOJI_OPTIONS = CONFIG.emojiOptions;
    const COLOR_OPTIONS = CONFIG.colorOptions;
    const ADMIN_PATTERN = CONFIG.adminPattern;
    const SUPABASE_URL = CONFIG.supabase.url;
    const SUPABASE_KEY = CONFIG.supabase.key;
    const supabaseHeaders = {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=minimal'
    };

    const toSnakeCase = (obj) => {
      if (!obj) return obj;
      const map = { assignedTo: 'assigned_to', createdAt: 'created_at', choreId: 'chore_id', completedBy: 'completed_by', completedAt: 'completed_at', assignmentMode: 'assignment_mode' };
      return Object.fromEntries(Object.entries(obj).map(([k, v]) => [map[k] || k, v]));
    };
    const toCamelCase = (obj) => {
      if (!obj) return obj;
      const map = { assigned_to: 'assignedTo', created_at: 'createdAt', chore_id: 'choreId', completed_by: 'completedBy', completed_at: 'completedAt', assignment_mode: 'assignmentMode' };
      return Object.fromEntries(Object.entries(obj).map(([k, v]) => [map[k] || k, v]));
    };

    const api = {
      async getAll() {
        try {
          const [choresRes, completionsRes, templatesRes, usersRes] = await Promise.all([
            fetch(`${SUPABASE_URL}/chores?select=*`, { headers: supabaseHeaders }),
            fetch(`${SUPABASE_URL}/completions?select=*`, { headers: supabaseHeaders }),
            fetch(`${SUPABASE_URL}/templates?select=*`, { headers: supabaseHeaders }),
            fetch(`${SUPABASE_URL}/users?select=*`, { headers: supabaseHeaders })
          ]);
          const [chores, completions, templates, users] = await Promise.all([
            choresRes.json(), completionsRes.json(), templatesRes.json(), usersRes.json()
          ]);
          return {
            chores: chores.map(toCamelCase),
            completions: completions.map(toCamelCase),
            templates: templates.map(toCamelCase),
            users: users.map(toCamelCase)
          };
        } catch (error) {
          console.error('API getAll error:', error);
          return null;
        }
      },
      async addChore(chore) {
        try {
          await fetch(`${SUPABASE_URL}/chores`, { method: 'POST', headers: supabaseHeaders, body: JSON.stringify(toSnakeCase(chore)) });
          return true;
        } catch (error) { console.error('API addChore error:', error); return false; }
      },
      async addChores(chores) {
        try {
          await fetch(`${SUPABASE_URL}/chores`, { method: 'POST', headers: supabaseHeaders, body: JSON.stringify(chores.map(toSnakeCase)) });
          return true;
        } catch (error) { console.error('API addChores error:', error); return false; }
      },
      async updateChore(chore) {
        try {
          await fetch(`${SUPABASE_URL}/chores?id=eq.${chore.id}`, { method: 'PATCH', headers: supabaseHeaders, body: JSON.stringify(toSnakeCase(chore)) });
          return true;
        } catch (error) { console.error('API updateChore error:', error); return false; }
      },
      async deleteChore(id) {
        try {
          await fetch(`${SUPABASE_URL}/chores?id=eq.${id}`, { method: 'DELETE', headers: supabaseHeaders });
          return true;
        } catch (error) { console.error('API deleteChore error:', error); return false; }
      },
      async addCompletion(completion) {
        try {
          await fetch(`${SUPABASE_URL}/completions`, { method: 'POST', headers: supabaseHeaders, body: JSON.stringify(toSnakeCase(completion)) });
          return true;
        } catch (error) { console.error('API addCompletion error:', error); return false; }
      },
      async deleteCompletion(id) {
        try {
          await fetch(`${SUPABASE_URL}/completions?id=eq.${id}`, { method: 'DELETE', headers: supabaseHeaders });
          return true;
        } catch (error) { console.error('API deleteCompletion error:', error); return false; }
      },
      async addTemplate(template) {
        try {
          await fetch(`${SUPABASE_URL}/templates`, { method: 'POST', headers: supabaseHeaders, body: JSON.stringify(toSnakeCase(template)) });
          return true;
        } catch (error) { console.error('API addTemplate error:', error); return false; }
      },
      async updateTemplate(template) {
        try {
          await fetch(`${SUPABASE_URL}/templates?id=eq.${template.id}`, { method: 'PATCH', headers: supabaseHeaders, body: JSON.stringify(toSnakeCase(template)) });
          return true;
        } catch (error) { console.error('API updateTemplate error:', error); return false; }
      },
      async deleteTemplate(id) {
        try {
          await fetch(`${SUPABASE_URL}/templates?id=eq.${id}`, { method: 'DELETE', headers: supabaseHeaders });
          return true;
        } catch (error) { console.error('API deleteTemplate error:', error); return false; }
      },
      async updateUsers(users) {
        try {
          console.log('Saving users to database:', users);
          const deleteRes = await fetch(`${SUPABASE_URL}/users?name=not.is.null`, { method: 'DELETE', headers: supabaseHeaders });
          if (!deleteRes.ok) {
            console.error('API updateUsers delete failed:', deleteRes.status, await deleteRes.text());
            return false;
          }
          console.log('Deleted existing users successfully');
          if (users.length > 0) {
            const usersData = users.map(toSnakeCase);
            console.log('Inserting users:', usersData);
            const insertRes = await fetch(`${SUPABASE_URL}/users`, { method: 'POST', headers: supabaseHeaders, body: JSON.stringify(usersData) });
            if (!insertRes.ok) {
              console.error('API updateUsers insert failed:', insertRes.status, await insertRes.text());
              return false;
            }
            console.log('Inserted users successfully');
          }
          return true;
        } catch (error) { console.error('API updateUsers error:', error); return false; }
      },
    };

    const storage = {
      get: (key, defaultValue) => {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : defaultValue;
        } catch { return defaultValue; }
      },
      set: (key, value) => localStorage.setItem(key, JSON.stringify(value))
    };

    const haptic = (type = 'light') => {
      if (navigator.vibrate) {
        const patterns = { light: 10, medium: 20, heavy: 30, success: [10, 50, 20] };
        navigator.vibrate(patterns[type] || 10);
      }
    };

    const getWeekBounds = (date = new Date()) => {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(d.setDate(diff));
      monday.setHours(0, 0, 0, 0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      sunday.setHours(23, 59, 59, 999);
      return { start: monday, end: sunday };
    };

    const formatDateShort = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const generateId = () => Math.random().toString(36).substr(2, 9);

    const getStyles = (dark) => ({
      container: { minHeight: '100vh', background: dark ? 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)' : 'linear-gradient(135deg, #45B7D110 0%, #ffffff 50%, #4ECDC410 100%)', fontFamily: "'Segoe UI', system-ui, sans-serif", color: dark ? '#e0e0e0' : '#2C3E50' },
      card: { background: dark ? '#1e1e2f' : 'white', borderRadius: '16px', padding: '20px', boxShadow: dark ? '0 4px 20px rgba(0,0,0,0.3)' : '0 4px 20px rgba(0,0,0,0.08)', marginBottom: '16px' },
      title: { fontSize: '28px', fontWeight: '700', color: dark ? '#ffffff' : '#2C3E50', margin: '0 0 8px 0' },
      subtitle: { fontSize: '14px', color: dark ? '#888' : '#2C3E5080', margin: 0 },
      button: { border: 'none', borderRadius: '12px', padding: '12px 24px', fontWeight: '600', cursor: 'pointer', transition: 'all 0.2s', fontSize: '16px' },
      input: { width: '100%', padding: '12px', border: dark ? '2px solid #333' : '2px solid #2C3E5020', borderRadius: '10px', fontSize: '16px', outline: 'none', boxSizing: 'border-box', background: dark ? '#2a2a3e' : 'white', color: dark ? '#e0e0e0' : '#2C3E50' },
      nav: { position: 'fixed', bottom: 0, left: 0, right: 0, background: dark ? '#1a1a2e' : 'white', borderTop: dark ? '1px solid #333' : '1px solid #2C3E5010', padding: '12px', display: 'flex', justifyContent: 'space-around' },
      navBtn: { display: 'flex', flexDirection: 'column', alignItems: 'center', background: 'none', border: 'none', cursor: 'pointer', padding: '8px' },
      tag: { fontSize: '11px', fontWeight: '600', padding: '4px 10px', borderRadius: '20px', display: 'inline-block' },
      modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '20px' },
      modal: { background: dark ? '#1e1e2f' : 'white', borderRadius: '20px', padding: '24px', maxWidth: '360px', width: '100%', boxShadow: '0 10px 40px rgba(0,0,0,0.3)', maxHeight: '90vh', overflowY: 'auto' },
    });

    function AppHeader({ darkMode }) {
      return (
        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px', paddingBottom: '12px', borderBottom: darkMode ? '1px solid #333' : '1px solid #e0e0e0' }}>
          <img src="icon.svg" alt="Logo" style={{ width: '48px', height: '48px' }} />
          <span style={{ fontSize: '18px', fontWeight: '700', color: darkMode ? '#e0e0e0' : '#2C3E50' }}>Do Your Chores, Bruh</span>
        </div>
      );
    }

    function AppFooter({ darkMode }) {
      return (
        <div style={{ textAlign: 'center', padding: '20px 16px', marginTop: 'auto', color: darkMode ? '#666' : '#999', fontSize: '12px' }}>
          Do Your Chores, Bruh ¬© 2026 Jordan Family
        </div>
      );
    }

    function UserSelect({ onSelect, users, completions, darkMode }) {
      const styles = getStyles(darkMode);
      const { start, end } = getWeekBounds(new Date());
      const weeklyScores = useMemo(() => {
        const scores = {};
        users.forEach(u => scores[u.name] = 0);
        completions.filter(c => { const d = new Date(c.completedAt); return d >= start && d <= end; }).forEach(c => { if (scores.hasOwnProperty(c.completedBy)) scores[c.completedBy] += c.points || 0; });
        return scores;
      }, [completions, users, start, end]);
      const leader = useMemo(() => {
        const sorted = users.map(u => ({ name: u.name, points: weeklyScores[u.name] || 0 })).sort((a, b) => b.points - a.points);
        return sorted[0]?.points > 0 ? sorted[0].name : null;
      }, [users, weeklyScores]);
      return (
        <div style={{ ...styles.container, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '24px', position: 'relative' }}>
          <div style={{ textAlign: 'center', marginBottom: '40px' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '14px', marginBottom: '8px' }}>
              <img src="icon.svg" alt="Logo" style={{ width: '64px', height: '64px' }} />
              <h1 style={{ ...styles.title, fontSize: '28px', margin: 0 }}>Do Your Chores, Bruh</h1>
            </div>
            <p style={styles.subtitle}>Who's checking in?</p>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', maxWidth: '320px', width: '100%', marginBottom: '24px' }}>
            {users.map((user) => (
              <button key={user.name} onClick={() => { haptic('medium'); onSelect(user.name); }} style={{ ...styles.button, background: user.color, color: 'white', padding: '16px 16px 20px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', position: 'relative', overflow: 'hidden' }}>
                {leader === user.name && <div style={{ position: 'absolute', top: 0, left: 0, right: 0, background: 'rgba(255,255,255,0.25)', padding: '2px 0', fontSize: '10px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>üëë Leader</div>}
                <span style={{ fontSize: '32px', marginTop: leader === user.name ? '16px' : '0' }}>{user.emoji}</span>
                <span style={{ fontWeight: '600' }}>{user.name}</span>
                <span style={{ fontSize: '12px', opacity: 0.85 }}>{weeklyScores[user.name] || 0} pts</span>
              </button>
            ))}
          </div>
          <button onClick={() => onSelect('admin')} style={{ ...styles.button, background: darkMode ? '#333' : '#2C3E50', color: 'white' }}>‚öôÔ∏è Admin</button>
          <div style={{ position: 'absolute', bottom: '20px', left: 0, right: 0, textAlign: 'center', color: darkMode ? '#666' : '#999', fontSize: '12px' }}>
            Do Your Chores, Bruh ¬© 2026 Jordan Family
          </div>
        </div>
      );
    }

    const PATTERN_EMOJI = [
      'üåü', 'üöÄ', 'üéÆ', 'üé®', 'üéµ', 'üìö', '‚ö°', 'üåà', 'üî•', 'üéØ',
      'üå∫', 'üé™', 'üé∏', 'üè†', 'üé≤', 'üåô', '‚òÄÔ∏è', 'üçï', 'üéÅ', 'üèÜ',
      'ü¶Ñ', 'üê∂', 'üê±', 'ü¶ä', 'üêº', 'ü¶Å', 'üê∏', 'ü¶ã', 'üåª', 'üçé',
      'üöó', '‚úàÔ∏è', 'üõ∏', '‚öΩ', 'üéæ', 'üèÄ', 'üéπ', 'üîÆ', 'üíé', 'üß©',
      'üå¥', 'üç¶', 'üéÇ', 'üß∏', 'üëë', 'ü¶ñ', 'üêô', 'üç©'
    ];

    function EmojiPattern({ onSuccess, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      const [taps, setTaps] = useState([]);
      const [error, setError] = useState(false);
      const [success, setSuccess] = useState(false);
      const [gridEmoji] = useState(() => {
        const shuffled = [...PATTERN_EMOJI].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, 9);
      });

      const handleTap = (position) => {
        if (error || success) return;
        haptic('light');
        const newTaps = [...taps, position];
        setTaps(newTaps);

        if (newTaps.length === ADMIN_PATTERN.length) {
          const isCorrect = newTaps.every((tap, i) => tap === ADMIN_PATTERN[i]);
          if (isCorrect) {
            setSuccess(true);
            haptic('success');
            setTimeout(() => onSuccess(), 400);
          } else {
            setError(true);
            haptic('heavy');
            setTimeout(() => { setError(false); setTaps([]); }, 800);
          }
        }
      };

      const getCellStyle = (position) => {
        const isSelected = taps.includes(position);
        const selectionIndex = taps.indexOf(position);
        return {
          width: '70px',
          height: '70px',
          fontSize: '32px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          borderRadius: '12px',
          cursor: 'pointer',
          transition: 'all 0.15s ease',
          background: error ? '#FF6B6B30' : success ? '#4ECDC430' : isSelected ? (darkMode ? '#4ECDC440' : '#45B7D130') : (darkMode ? '#2a2a3e' : '#f5f5f5'),
          border: `2px solid ${error ? '#FF6B6B' : success ? '#4ECDC4' : isSelected ? '#45B7D1' : 'transparent'}`,
          transform: isSelected ? 'scale(0.95)' : 'scale(1)',
          position: 'relative',
        };
      };

      return (
        <div style={{ ...styles.container, display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '24px', position: 'relative' }}>
          <div style={{ ...styles.card, maxWidth: '320px', width: '100%' }}>
            <h2 style={{ ...styles.title, fontSize: '20px', textAlign: 'center', marginBottom: '8px' }}>Admin Access</h2>
            <p style={{ textAlign: 'center', color: darkMode ? '#888' : '#666', fontSize: '14px', marginBottom: '20px' }}>
              Tap the pattern to continue
            </p>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '12px', justifyItems: 'center', marginBottom: '16px' }}>
              {[1, 2, 3, 4, 5, 6, 7, 8, 9].map((position, index) => (
                <div key={position} onClick={() => handleTap(position)} style={getCellStyle(position)}>
                  {gridEmoji[index]}
                </div>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '8px', justifyContent: 'center', marginBottom: '16px', minHeight: '24px' }}>
              {ADMIN_PATTERN.map((_, i) => (
                <div key={i} style={{
                  width: '12px',
                  height: '12px',
                  borderRadius: '50%',
                  background: taps[i] ? (error ? '#FF6B6B' : success ? '#4ECDC4' : '#45B7D1') : (darkMode ? '#333' : '#ddd'),
                  transition: 'all 0.15s ease',
                }} />
              ))}
            </div>
            <button type="button" onClick={onCancel} style={{ ...styles.button, width: '100%', background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
          </div>
          <div style={{ position: 'absolute', bottom: '20px', left: 0, right: 0, textAlign: 'center', color: darkMode ? '#666' : '#999', fontSize: '12px' }}>
            Do Your Chores, Bruh ¬© 2026 Jordan Family
          </div>
        </div>
      );
    }

    function ConfirmModal({ message, onConfirm, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      return (
        <div style={styles.modalOverlay}>
          <div style={styles.modal}>
            <p style={{ margin: '0 0 20px 0', fontSize: '16px', textAlign: 'center' }}>{message}</p>
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onCancel} style={{ ...styles.button, flex: 1, background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
              <button onClick={() => { haptic('medium'); onConfirm(); }} style={{ ...styles.button, flex: 1, background: '#FF6B6B', color: 'white' }}>Delete</button>
            </div>
          </div>
        </div>
      );
    }

    function UserPickerModal({ chore, users, onSelect, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      return (
        <div style={styles.modalOverlay}>
          <div style={styles.modal}>
            <h3 style={{ margin: '0 0 8px 0', fontSize: '18px', fontWeight: '700', textAlign: 'center' }}>Who completed this?</h3>
            <p style={{ margin: '0 0 20px 0', fontSize: '14px', color: '#999', textAlign: 'center' }}>{chore.description}</p>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '12px' }}>
              {users.map(user => (
                <button key={user.name} onClick={() => { haptic('medium'); onSelect(user.name); }} style={{ ...styles.button, background: user.color, color: 'white', padding: '16px 12px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px' }}>
                  <span style={{ fontSize: '24px' }}>{user.emoji}</span>
                  <span style={{ fontSize: '14px' }}>{user.name}</span>
                </button>
              ))}
            </div>
            <button onClick={() => { haptic('light'); onSelect('parent'); }} style={{ ...styles.button, width: '100%', background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666', marginBottom: '12px' }}>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent (no points)</button>
            <button onClick={onCancel} style={{ ...styles.button, width: '100%', background: 'transparent', color: '#999', border: darkMode ? '2px solid #333' : '2px solid #eee' }}>Cancel</button>
          </div>
        </div>
      );
    }

    function MultiUserPickerModal({ users, onConfirm, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      const [selected, setSelected] = useState([]);
      const toggleUser = (name) => setSelected(prev => prev.includes(name) ? prev.filter(n => n !== name) : [...prev, name]);
      return (
        <div style={styles.modalOverlay}>
          <div style={styles.modal}>
            <h3 style={{ margin: '0 0 16px 0', fontSize: '18px', fontWeight: '700', textAlign: 'center' }}>Assign to multiple kids</h3>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '16px' }}>
              {users.map(user => (
                <button key={user.name} onClick={() => { haptic('light'); toggleUser(user.name); }} style={{ ...styles.button, background: selected.includes(user.name) ? user.color : (darkMode ? '#333' : '#f0f0f0'), color: selected.includes(user.name) ? 'white' : (darkMode ? '#ccc' : '#666'), padding: '16px 12px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px' }}>
                  <span style={{ fontSize: '24px' }}>{user.emoji}</span>
                  <span style={{ fontSize: '14px' }}>{user.name}</span>
                  {selected.includes(user.name) && <span style={{ fontSize: '12px' }}>‚úì</span>}
                </button>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onCancel} style={{ ...styles.button, flex: 1, background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
              <button onClick={() => { haptic('success'); onConfirm(selected); }} disabled={selected.length === 0} style={{ ...styles.button, flex: 1, background: selected.length ? '#4ECDC4' : '#ccc', color: 'white' }}>Assign ({selected.length})</button>
            </div>
          </div>
        </div>
      );
    }

    function AssignmentPreviewModal({ assignments, optionalChores, users, onShuffle, onConfirm, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      const getUser = (name) => users.find(u => u.name === name);
      return (
        <div style={styles.modalOverlay}>
          <div style={{ ...styles.modal, maxWidth: '400px' }}>
            <h3 style={{ margin: '0 0 16px 0', fontSize: '18px', fontWeight: '700', textAlign: 'center' }}>Preview Chore Assignment</h3>
            {assignments.length > 0 && (
              <div style={{ marginBottom: '16px' }}>
                <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: '600', color: '#FF6B6B' }}>üé≤ Random Assignments</h4>
                {assignments.map((a, i) => {
                  const user = getUser(a.assignedTo);
                  return (
                    <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 12px', background: darkMode ? '#2a2a3e' : '#f8f8f8', borderRadius: '8px', marginBottom: '6px', borderLeft: `3px solid ${user?.color || '#999'}` }}>
                      <span style={{ fontSize: '18px' }}>{user?.emoji || 'üë§'}</span>
                      <span style={{ flex: 1, fontSize: '14px' }}>{a.description}</span>
                      <span style={{ fontSize: '12px', fontWeight: '600', color: user?.color || '#999' }}>{a.assignedTo}</span>
                    </div>
                  );
                })}
              </div>
            )}
            {optionalChores.length > 0 && (
              <div style={{ marginBottom: '16px' }}>
                <h4 style={{ margin: '0 0 8px 0', fontSize: '14px', fontWeight: '600', color: '#4ECDC4' }}>‚≠ê Optional Chores</h4>
                {optionalChores.map((c, i) => (
                  <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 12px', background: darkMode ? '#2a2a3e' : '#f8f8f8', borderRadius: '8px', marginBottom: '6px', borderLeft: '3px solid #4ECDC4' }}>
                    <span style={{ flex: 1, fontSize: '14px' }}>{c.description}</span>
                    <span style={{ fontSize: '14px', fontWeight: '700', color: '#FFE66D' }}>{c.points} pts</span>
                  </div>
                ))}
              </div>
            )}
            <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
              <button onClick={onCancel} style={{ ...styles.button, flex: '1 1 80px', background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
              <button onClick={() => { haptic('light'); onShuffle(); }} style={{ ...styles.button, background: '#9B59B6', color: 'white', padding: '12px 16px' }}>üîÄ Shuffle</button>
              <button onClick={() => { haptic('success'); onConfirm(); }} style={{ ...styles.button, flex: '1 1 80px', background: '#4ECDC4', color: 'white' }}>‚úì Create</button>
            </div>
          </div>
        </div>
      );
    }

    function KidExclusionModal({ users, excludeCount, onConfirm, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      const [excluded, setExcluded] = useState([]);
      const toggleExclude = (name) => setExcluded(prev => prev.includes(name) ? prev.filter(n => n !== name) : prev.length < excludeCount ? [...prev, name] : prev);
      return (
        <div style={styles.modalOverlay}>
          <div style={styles.modal}>
            <h3 style={{ margin: '0 0 8px 0', fontSize: '18px', fontWeight: '700', textAlign: 'center' }}>Select Kids to Exclude</h3>
            <p style={{ margin: '0 0 16px 0', fontSize: '14px', color: '#999', textAlign: 'center' }}>You have fewer random chores than kids. Select {excludeCount} kid{excludeCount > 1 ? 's' : ''} to skip this time.</p>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', marginBottom: '16px' }}>
              {users.map(user => (
                <button key={user.name} onClick={() => { haptic('light'); toggleExclude(user.name); }} style={{ ...styles.button, background: excluded.includes(user.name) ? '#FF6B6B' : (darkMode ? '#333' : '#f0f0f0'), color: excluded.includes(user.name) ? 'white' : (darkMode ? '#ccc' : '#666'), padding: '16px 12px', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', opacity: excluded.includes(user.name) ? 0.7 : 1 }}>
                  <span style={{ fontSize: '24px' }}>{user.emoji}</span>
                  <span style={{ fontSize: '14px' }}>{user.name}</span>
                  {excluded.includes(user.name) && <span style={{ fontSize: '12px' }}>‚ùå Excluded</span>}
                </button>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onCancel} style={{ ...styles.button, flex: 1, background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
              <button onClick={() => { haptic('medium'); onConfirm(excluded); }} disabled={excluded.length !== excludeCount} style={{ ...styles.button, flex: 1, background: excluded.length === excludeCount ? '#4ECDC4' : '#ccc', color: 'white' }}>Continue</button>
            </div>
          </div>
        </div>
      );
    }

    function EditChoreModal({ chore, users, onSave, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      const [formData, setFormData] = useState({ description: chore.description, points: chore.points || '', assignedTo: chore.assignedTo || users[0]?.name });
      const handleSave = () => {
        if (!formData.description.trim()) return;
        haptic('success');
        onSave({ ...chore, description: formData.description, points: chore.type === 'optional' ? (parseInt(formData.points) || 0) : 0, assignedTo: chore.type === 'mandatory' ? formData.assignedTo : null });
      };
      return (
        <div style={styles.modalOverlay}>
          <div style={styles.modal}>
            <h3 style={{ margin: '0 0 16px 0', fontSize: '18px', fontWeight: '700' }}>Edit Chore</h3>
            <div style={{ marginBottom: '16px' }}>
              <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Description</label>
              <input type="text" value={formData.description} onChange={(e) => setFormData(f => ({ ...f, description: e.target.value }))} style={styles.input} />
            </div>
            {chore.type === 'optional' && (
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Points</label>
                <input type="number" value={formData.points} onChange={(e) => setFormData(f => ({ ...f, points: e.target.value }))} style={styles.input} />
              </div>
            )}
            {chore.type === 'mandatory' && (
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Assigned To</label>
                <select value={formData.assignedTo} onChange={(e) => setFormData(f => ({ ...f, assignedTo: e.target.value }))} style={{ ...styles.input, background: darkMode ? '#2a2a3e' : 'white' }}>
                  {users.map(u => <option key={u.name} value={u.name}>{u.name}</option>)}
                </select>
              </div>
            )}
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onCancel} style={{ ...styles.button, flex: 1, background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
              <button onClick={handleSave} style={{ ...styles.button, flex: 1, background: '#4ECDC4', color: 'white' }}>Save</button>
            </div>
          </div>
        </div>
      );
    }

    function CustomizeKidsModal({ users, onSave, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      const [editingUsers, setEditingUsers] = useState(users.map(u => ({ ...u })));
      const [activeKid, setActiveKid] = useState(0);
      const updateUser = (index, field, value) => setEditingUsers(prev => prev.map((u, i) => i === index ? { ...u, [field]: value } : u));
      const addKid = () => {
        const newKid = { name: 'New Kid', emoji: 'üßí', color: COLOR_OPTIONS[editingUsers.length % COLOR_OPTIONS.length] };
        setEditingUsers(prev => [...prev, newKid]);
        setActiveKid(editingUsers.length);
        haptic('medium');
      };
      const removeKid = (index) => {
        if (editingUsers.length <= 1) return;
        setEditingUsers(prev => prev.filter((_, i) => i !== index));
        setActiveKid(prev => prev >= index ? Math.max(0, prev - 1) : prev);
        haptic('medium');
      };
      return (
        <div style={styles.modalOverlay}>
          <div style={{ ...styles.modal, maxWidth: '600px', width: '95%', maxHeight: '90vh', display: 'flex', flexDirection: 'column' }}>
            <h3 style={{ margin: '0 0 16px 0', fontSize: '18px', fontWeight: '700', flexShrink: 0 }}>Customize Kids</h3>
            <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', overflowX: 'auto', flexShrink: 0, paddingBottom: '4px' }}>
              {editingUsers.map((user, i) => (
                <button key={i} onClick={() => setActiveKid(i)} style={{ ...styles.button, padding: '8px 16px', background: activeKid === i ? user.color : (darkMode ? '#333' : '#f0f0f0'), color: activeKid === i ? 'white' : (darkMode ? '#ccc' : '#666'), fontSize: '14px', whiteSpace: 'nowrap', position: 'relative' }}>{user.emoji} {user.name}</button>
              ))}
              <button onClick={addKid} style={{ ...styles.button, padding: '8px 16px', background: darkMode ? '#2a4a2a' : '#e8f5e9', color: darkMode ? '#4CAF50' : '#2e7d32', fontSize: '18px', fontWeight: '700' }}>+</button>
            </div>
            <div style={{ display: 'flex', gap: '16px', flexDirection: window.innerWidth < 600 ? 'column' : 'row', flex: 1, minHeight: 0 }}>
              <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0 }}>
                <div style={{ marginBottom: '12px', flexShrink: 0 }}>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Name</label>
                  <input type="text" value={editingUsers[activeKid].name} onChange={(e) => updateUser(activeKid, 'name', e.target.value)} style={styles.input} />
                </div>
                <div style={{ flex: 1, minHeight: 0, display: 'flex', flexDirection: 'column' }}>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px', flexShrink: 0 }}>Avatar</label>
                  <div style={{ flex: 1, minHeight: '120px', maxHeight: '200px', overflowY: 'auto', border: darkMode ? '1px solid #333' : '1px solid #e0e0e0', borderRadius: '12px', padding: '8px' }}>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                      {EMOJI_OPTIONS.map(emoji => (
                        <button key={emoji} onClick={() => { haptic('light'); updateUser(activeKid, 'emoji', emoji); }} style={{ width: '40px', height: '40px', fontSize: '22px', border: editingUsers[activeKid].emoji === emoji ? `3px solid ${editingUsers[activeKid].color}` : (darkMode ? '2px solid #333' : '2px solid #eee'), borderRadius: '8px', background: darkMode ? '#2a2a3e' : 'white', cursor: 'pointer' }}>{emoji}</button>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
              <div style={{ width: window.innerWidth < 600 ? '100%' : '180px', flexShrink: 0, display: 'flex', flexDirection: 'column', gap: '12px' }}>
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Color</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <input type="color" value={editingUsers[activeKid].color} onChange={(e) => { haptic('light'); updateUser(activeKid, 'color', e.target.value); }} style={{ width: '60px', height: '60px', border: 'none', borderRadius: '12px', cursor: 'pointer', padding: 0, background: 'transparent' }} />
                    <div style={{ flex: 1 }}>
                      <div style={{ width: '100%', height: '40px', background: editingUsers[activeKid].color, borderRadius: '8px', marginBottom: '4px' }} />
                      <span style={{ fontSize: '12px', color: '#999', fontFamily: 'monospace' }}>{editingUsers[activeKid].color}</span>
                    </div>
                  </div>
                </div>
                {editingUsers.length > 1 && (
                  <button onClick={() => removeKid(activeKid)} style={{ ...styles.button, background: darkMode ? '#4a2a2a' : '#ffebee', color: '#f44336', fontSize: '14px', padding: '10px' }}>Remove {editingUsers[activeKid].name}</button>
                )}
              </div>
            </div>
            <div style={{ display: 'flex', gap: '12px', marginTop: '16px', flexShrink: 0 }}>
              <button onClick={onCancel} style={{ ...styles.button, flex: 1, background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
              <button onClick={() => { haptic('success'); onSave(editingUsers); }} style={{ ...styles.button, flex: 1, background: '#4ECDC4', color: 'white' }}>Save</button>
            </div>
          </div>
        </div>
      );
    }

    function UserCustomizeModal({ user, onSave, onCancel, darkMode }) {
      const styles = getStyles(darkMode);
      const [editingUser, setEditingUser] = useState({ ...user });
      return (
        <div style={styles.modalOverlay}>
          <div style={{ ...styles.modal, maxWidth: '400px', width: '95%' }}>
            <h3 style={{ margin: '0 0 16px 0', fontSize: '18px', fontWeight: '700' }}>Customize Your Profile</h3>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px', padding: '12px', background: `${editingUser.color}22`, borderRadius: '12px', border: `2px solid ${editingUser.color}` }}>
              <span style={{ fontSize: '40px' }}>{editingUser.emoji}</span>
              <div>
                <div style={{ fontSize: '18px', fontWeight: '700' }}>{user.name}</div>
                <div style={{ fontSize: '12px', color: '#999' }}>Preview</div>
              </div>
            </div>
            <div style={{ marginBottom: '16px' }}>
              <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Avatar</label>
              <div style={{ maxHeight: '180px', overflowY: 'auto', border: darkMode ? '1px solid #333' : '1px solid #e0e0e0', borderRadius: '12px', padding: '8px' }}>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px' }}>
                  {EMOJI_OPTIONS.map(emoji => (
                    <button key={emoji} onClick={() => { haptic('light'); setEditingUser(u => ({ ...u, emoji })); }} style={{ width: '44px', height: '44px', fontSize: '24px', border: editingUser.emoji === emoji ? `3px solid ${editingUser.color}` : (darkMode ? '2px solid #333' : '2px solid #eee'), borderRadius: '8px', background: darkMode ? '#2a2a3e' : 'white', cursor: 'pointer' }}>{emoji}</button>
                  ))}
                </div>
              </div>
            </div>
            <div style={{ marginBottom: '20px' }}>
              <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Color</label>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <input type="color" value={editingUser.color} onChange={(e) => { haptic('light'); setEditingUser(u => ({ ...u, color: e.target.value })); }} style={{ width: '60px', height: '60px', border: 'none', borderRadius: '12px', cursor: 'pointer', padding: 0, background: 'transparent' }} />
                <div style={{ flex: 1 }}>
                  <div style={{ width: '100%', height: '40px', background: editingUser.color, borderRadius: '8px', marginBottom: '4px' }} />
                  <span style={{ fontSize: '12px', color: '#999', fontFamily: 'monospace' }}>{editingUser.color}</span>
                </div>
              </div>
            </div>
            <div style={{ display: 'flex', gap: '12px' }}>
              <button onClick={onCancel} style={{ ...styles.button, flex: 1, background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
              <button onClick={() => { haptic('success'); onSave(editingUser); }} style={{ ...styles.button, flex: 1, background: '#4ECDC4', color: 'white' }}>Save</button>
            </div>
          </div>
        </div>
      );
    }

    function UndoToast({ completion, onUndo, onDismiss, darkMode }) {
      useEffect(() => { const timer = setTimeout(onDismiss, 5000); return () => clearTimeout(timer); }, [onDismiss]);
      return (
        <div style={{ position: 'fixed', bottom: '80px', left: '50%', transform: 'translateX(-50%)', background: darkMode ? '#333' : '#2C3E50', color: 'white', padding: '12px 20px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '16px', boxShadow: '0 4px 20px rgba(0,0,0,0.3)', zIndex: 999 }}>
          <span style={{ fontSize: '14px' }}>Completed: {completion.description}</span>
          <button onClick={() => { haptic('medium'); onUndo(); }} style={{ background: '#4ECDC4', color: 'white', border: 'none', padding: '6px 12px', borderRadius: '6px', fontWeight: '600', cursor: 'pointer' }}>Undo</button>
        </div>
      );
    }

    function Scoreboard({ completions, users, weekOffset = 0, onWeekChange, darkMode }) {
      const styles = getStyles(darkMode);
      const baseDate = new Date();
      baseDate.setDate(baseDate.getDate() + (weekOffset * 7));
      const { start, end } = getWeekBounds(baseDate);
      const weeklyScores = useMemo(() => {
        const scores = {};
        users.forEach(u => scores[u.name] = 0);
        completions.filter(c => { const d = new Date(c.completedAt); return d >= start && d <= end; }).forEach(c => { if (scores.hasOwnProperty(c.completedBy)) scores[c.completedBy] += c.points || 0; });
        return users.map(u => ({ ...u, points: scores[u.name] || 0 })).sort((a, b) => b.points - a.points);
      }, [completions, users, start, end]);
      const isCurrentWeek = weekOffset === 0;
      return (
        <div style={styles.card}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
            <button onClick={() => onWeekChange(weekOffset - 1)} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: 'pointer', padding: '4px' }}>‚Üê</button>
            <div style={{ textAlign: 'center' }}>
              <h2 style={{ margin: 0, fontSize: '16px', fontWeight: '700' }}>üèÜ {isCurrentWeek ? "This Week" : weekOffset === -1 ? "Last Week" : `${Math.abs(weekOffset)} weeks ago`}</h2>
              <span style={{ fontSize: '12px', color: '#999' }}>{formatDateShort(start)} - {formatDateShort(end)}</span>
            </div>
            <button onClick={() => onWeekChange(weekOffset + 1)} disabled={isCurrentWeek} style={{ background: 'none', border: 'none', fontSize: '20px', cursor: isCurrentWeek ? 'default' : 'pointer', padding: '4px', opacity: isCurrentWeek ? 0.3 : 1 }}>‚Üí</button>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '10px' }}>
            {weeklyScores.map((s, i) => (
              <div key={s.name} style={{ background: `${s.color}22`, border: `2px solid ${s.color}44`, borderRadius: '12px', padding: '12px 8px', textAlign: 'center' }}>
                <div style={{ fontSize: '20px', position: 'relative', display: 'inline-block' }}>
                  {i === 0 && s.points > 0 && (
                    <span style={{ position: 'absolute', top: '-2px', left: '50%', transform: 'translateX(-50%)', zIndex: 2 }}>üëë</span>
                  )}
                  {i === 0 && s.points > 0 && (
                    <span style={{ position: 'absolute', top: '8px', left: '50%', transform: 'translateX(-50%)', zIndex: 3, fontSize: '12px' }}>üòé</span>
                  )}
                  <span style={{ visibility: i === 0 && s.points > 0 ? 'hidden' : 'visible' }}>{s.emoji}</span>
                  {i === 0 && s.points > 0 && <span style={{ marginTop: '14px', display: 'block' }}>{s.emoji}</span>}
                </div>
                <div style={{ fontSize: '12px', fontWeight: '600', marginTop: '4px' }}>{s.name}</div>
                <div style={{ fontSize: '24px', fontWeight: '700' }}>{s.points}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function ChoreCard({ chore, currentUser, users, onComplete, onEdit, isAdmin, darkMode }) {
      const styles = getStyles(darkMode);
      const [showPicker, setShowPicker] = useState(false);
      const [completing, setCompleting] = useState(false);
      const canComplete = isAdmin || chore.type === 'optional' || chore.assignedTo === currentUser;
      const isMandatory = chore.type === 'mandatory';
      const user = users.find(u => u.name === chore.assignedTo);
      const handleCompleteClick = () => {
        haptic('light');
        if (isAdmin) setShowPicker(true);
        else {
          setCompleting(true);
          setTimeout(() => onComplete(chore, currentUser), 350);
        }
      };
      const handlePickerSelect = (selectedUser) => {
        setShowPicker(false);
        setCompleting(true);
        setTimeout(() => onComplete(chore, selectedUser === 'parent' ? null : selectedUser), 350);
      };
      return (
        <div className={completing ? 'chore-completing' : ''} style={{ ...styles.card, borderLeft: `4px solid ${isMandatory ? '#FF6B6B' : '#4ECDC4'}`, marginBottom: '12px' }}>
          {showPicker && <UserPickerModal chore={chore} users={users} onSelect={handlePickerSelect} onCancel={() => setShowPicker(false)} darkMode={darkMode} />}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '12px' }}>
            <div style={{ flex: 1 }}>
              <div style={{ display: 'flex', gap: '8px', marginBottom: '8px', flexWrap: 'wrap' }}>
                <span style={{ ...styles.tag, background: isMandatory ? '#FF6B6B20' : '#4ECDC420', color: isMandatory ? '#FF6B6B' : '#4ECDC4' }}>{isMandatory ? 'üìå Required' : '‚≠ê Optional'}</span>
                {isMandatory && user && <span style={{ ...styles.tag, background: `${user.color}22`, color: user.color }}>{user.emoji} {user.name}</span>}
              </div>
              <h3 style={{ margin: 0, fontSize: '16px', fontWeight: '600' }}>{chore.description}</h3>
            </div>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '8px' }}>
              {chore.points > 0 && <div><span style={{ fontSize: '24px', fontWeight: '700', color: '#FFE66D' }}>{chore.points}</span><span style={{ fontSize: '12px', color: '#999', marginLeft: '4px' }}>pts</span></div>}
              {isAdmin && <button onClick={() => onEdit(chore)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '16px', padding: '4px' }}>‚úèÔ∏è</button>}
            </div>
          </div>
          {canComplete ? (
            <button onClick={handleCompleteClick} style={{ ...styles.button, width: '100%', marginTop: '12px', background: isMandatory ? '#FF6B6B15' : '#4ECDC415', color: isMandatory ? '#FF6B6B' : '#4ECDC4' }}>‚úì Mark Complete</button>
          ) : (
            <div style={{ marginTop: '12px', padding: '10px', background: darkMode ? '#2a2a3e' : '#f5f5f5', borderRadius: '8px', textAlign: 'center', color: '#999', fontSize: '14px' }}>Assigned to {chore.assignedTo}</div>
          )}
        </div>
      );
    }

    function FilterBar({ filter, onFilterChange, users, darkMode }) {
      const styles = getStyles(darkMode);
      return (
        <div style={{ display: 'flex', gap: '8px', marginBottom: '16px', overflowX: 'auto', paddingBottom: '4px' }}>
          <button onClick={() => onFilterChange('all')} style={{ ...styles.button, padding: '8px 16px', fontSize: '13px', background: filter === 'all' ? (darkMode ? '#4ECDC4' : '#2C3E50') : (darkMode ? '#333' : '#f0f0f0'), color: filter === 'all' ? 'white' : (darkMode ? '#ccc' : '#666'), whiteSpace: 'nowrap' }}>All</button>
          {users.map(user => (
            <button key={user.name} onClick={() => onFilterChange(user.name)} style={{ ...styles.button, padding: '8px 16px', fontSize: '13px', background: filter === user.name ? user.color : (darkMode ? '#333' : '#f0f0f0'), color: filter === user.name ? 'white' : (darkMode ? '#ccc' : '#666'), whiteSpace: 'nowrap' }}>{user.emoji} {user.name}</button>
          ))}
        </div>
      );
    }

    function ChoreView({ currentUser, isAdmin, chores, completions, users, onComplete, onEdit, onNavigate, onLogout, onSaveUser, darkMode, weekOffset, onWeekChange }) {
      const styles = getStyles(darkMode);
      const [filter, setFilter] = useState('all');
      const [showCustomize, setShowCustomize] = useState(false);
      const currentUserObj = users.find(u => u.name === currentUser);
      const activeChores = chores.filter(c => c.status === 'active');
      const filteredChores = activeChores.filter(c => { if (filter === 'all') return true; if (c.type === 'optional') return true; return c.assignedTo === filter; });
      const mandatoryChores = filteredChores.filter(c => c.type === 'mandatory');
      const optionalChores = filteredChores.filter(c => c.type === 'optional');
      return (
        <div style={{ ...styles.container, padding: '16px', paddingBottom: '100px', display: 'flex', flexDirection: 'column' }}>
          {showCustomize && currentUserObj && <UserCustomizeModal user={currentUserObj} onSave={(updatedUser) => { onSaveUser(updatedUser); setShowCustomize(false); }} onCancel={() => setShowCustomize(false)} darkMode={darkMode} />}
          <AppHeader darkMode={darkMode} />
          <div style={{ flex: 1 }}>
            <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                {!isAdmin && currentUserObj && (
                  <button onClick={() => { haptic('light'); setShowCustomize(true); }} style={{ fontSize: '32px', background: 'none', border: 'none', cursor: 'pointer', padding: '4px' }} title="Customize your profile">{currentUserObj.emoji}</button>
                )}
                <div>
                  <h1 style={{ ...styles.title, fontSize: '22px' }}>{isAdmin ? '‚öôÔ∏è Admin View' : `Hi, ${currentUser}!`}</h1>
                  <p style={styles.subtitle}>{isAdmin ? 'Manage chores below' : 'Complete chores to earn points'}</p>
                </div>
              </div>
            </header>
            <Scoreboard completions={completions} users={users} weekOffset={weekOffset} onWeekChange={onWeekChange} darkMode={darkMode} />
            <FilterBar filter={filter} onFilterChange={setFilter} users={users} darkMode={darkMode} />
            {mandatoryChores.length > 0 && (
              <section style={{ marginBottom: '24px' }}>
                <h2 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '12px' }}><span style={{ color: '#FF6B6B' }}>üìå</span> Required Chores</h2>
                {mandatoryChores.map(chore => <ChoreCard key={chore.id} chore={chore} currentUser={currentUser} users={users} isAdmin={isAdmin} onComplete={onComplete} onEdit={onEdit} darkMode={darkMode} />)}
              </section>
            )}
            {optionalChores.length > 0 && (
              <section style={{ marginBottom: '24px' }}>
                <h2 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '12px' }}><span style={{ color: '#4ECDC4' }}>‚≠ê</span> Optional Chores</h2>
                {optionalChores.map(chore => <ChoreCard key={chore.id} chore={chore} currentUser={currentUser} users={users} isAdmin={isAdmin} onComplete={onComplete} onEdit={onEdit} darkMode={darkMode} />)}
              </section>
            )}
            {filteredChores.length === 0 && (
              <div style={{ textAlign: 'center', padding: '60px 20px' }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üéâ</div>
                <h3 style={{ fontSize: '20px', fontWeight: '700', margin: '0 0 8px 0' }}>All done!</h3>
                <p style={{ color: '#999', margin: 0 }}>No chores right now. Enjoy!</p>
              </div>
            )}
          </div>
          <AppFooter darkMode={darkMode} />
          <nav style={styles.nav}>
            <button onClick={onLogout} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üè†</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Home</span></button>
            <button style={{ ...styles.navBtn, color: '#45B7D1' }}><span style={{ fontSize: '20px' }}>üìã</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Chores</span></button>
            <button onClick={() => onNavigate('history')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üìä</span><span style={{ fontSize: '11px', fontWeight: '600' }}>History</span></button>
            {isAdmin && <button onClick={() => onNavigate('manage')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>‚öôÔ∏è</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Manage</span></button>}
            {isAdmin && <button onClick={() => onNavigate('settings')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üé®</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Settings</span></button>}
          </nav>
        </div>
      );
    }

    function HistoryView({ completions, users, onNavigate, onUndo, onLogout, isAdmin, darkMode, weekOffset = 0, onWeekChange }) {
      const styles = getStyles(darkMode);
      const baseDate = new Date();
      baseDate.setDate(baseDate.getDate() + (weekOffset * 7));
      const { start, end } = getWeekBounds(baseDate);
      const filteredCompletions = useMemo(() => {
        return completions.filter(c => { const d = new Date(c.completedAt); return d >= start && d <= end; }).sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
      }, [completions, start, end]);
      const getUser = (name) => users.find(u => u.name === name) || { color: '#999', emoji: 'üë§' };
      const isCurrentWeek = weekOffset === 0;
      const formatDay = (date) => new Date(date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
      const groupedByDay = useMemo(() => {
        const groups = {};
        filteredCompletions.forEach(c => {
          const dayKey = new Date(c.completedAt).toDateString();
          if (!groups[dayKey]) groups[dayKey] = [];
          groups[dayKey].push(c);
        });
        return Object.entries(groups).sort((a, b) => new Date(b[0]) - new Date(a[0]));
      }, [filteredCompletions]);
      return (
        <div style={{ ...styles.container, padding: '16px', paddingBottom: '100px', display: 'flex', flexDirection: 'column' }}>
          <AppHeader darkMode={darkMode} />
          <div style={{ flex: 1 }}>
            <header style={{ marginBottom: '20px' }}><h1 style={{ ...styles.title, fontSize: '22px' }}>üìä Completed Chores</h1><p style={styles.subtitle}>See what's been accomplished</p></header>
            <div style={{ ...styles.card, marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <button onClick={() => onWeekChange(weekOffset - 1)} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', padding: '8px' }}>‚Üê</button>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: '16px', fontWeight: '700' }}>{isCurrentWeek ? "This Week" : weekOffset === -1 ? "Last Week" : `${Math.abs(weekOffset)} weeks ago`}</div>
                <span style={{ fontSize: '12px', color: '#999' }}>{formatDateShort(start)} - {formatDateShort(end)}</span>
              </div>
              <button onClick={() => onWeekChange(weekOffset + 1)} disabled={isCurrentWeek} style={{ background: 'none', border: 'none', fontSize: '24px', cursor: isCurrentWeek ? 'default' : 'pointer', padding: '8px', opacity: isCurrentWeek ? 0.3 : 1 }}>‚Üí</button>
            </div>
            {groupedByDay.length > 0 ? (
              <div>{groupedByDay.map(([dayKey, dayCompletions]) => (
                <div key={dayKey} style={{ marginBottom: '20px' }}>
                  <div style={{ fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px', paddingLeft: '4px' }}>{formatDay(dayKey)}</div>
                  {dayCompletions.map((c) => { const user = getUser(c.completedBy); return (
                    <div key={c.id} style={{ ...styles.card, borderLeft: `4px solid ${user.color}`, marginBottom: '8px' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                        <div style={{ flex: 1 }}><div style={{ fontWeight: '600', marginBottom: '4px' }}>{c.description}</div><div style={{ fontSize: '13px', color: '#999' }}>{user.emoji} <span style={{ fontWeight: '600' }}>{c.completedBy}</span><span style={{ margin: '0 8px' }}>‚Ä¢</span>{new Date(c.completedAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</div></div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>{c.points > 0 && <div style={{ fontSize: '20px', fontWeight: '700', color: '#FFE66D' }}>+{c.points}</div>}{isAdmin && <button onClick={() => onUndo(c)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '14px', color: '#999' }} title="Undo">‚Ü©Ô∏è</button>}</div>
                      </div>
                    </div>
                  ); })}
                </div>
              ))}</div>
            ) : (<div style={{ textAlign: 'center', padding: '60px 20px' }}><div style={{ fontSize: '40px', marginBottom: '12px' }}>üì≠</div><p style={{ color: '#999', margin: 0 }}>No chores completed this week</p></div>)}
          </div>
          <AppFooter darkMode={darkMode} />
          <nav style={styles.nav}>
            <button onClick={onLogout} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üè†</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Home</span></button>
            <button onClick={() => onNavigate('chores')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üìã</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Chores</span></button>
            <button style={{ ...styles.navBtn, color: '#45B7D1' }}><span style={{ fontSize: '20px' }}>üìä</span><span style={{ fontSize: '11px', fontWeight: '600' }}>History</span></button>
            {isAdmin && <button onClick={() => onNavigate('manage')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>‚öôÔ∏è</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Manage</span></button>}
            {isAdmin && <button onClick={() => onNavigate('settings')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üé®</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Settings</span></button>}
          </nav>
        </div>
      );
    }

    function SettingsView({ users, onSaveUsers, darkMode, onToggleDarkMode, onNavigate, onLogout }) {
      const styles = getStyles(darkMode);
      const [showCustomize, setShowCustomize] = useState(false);
      return (
        <div style={{ ...styles.container, padding: '16px', paddingBottom: '100px', display: 'flex', flexDirection: 'column' }}>
          <AppHeader darkMode={darkMode} />
          <div style={{ flex: 1 }}>
            <header style={{ marginBottom: '20px' }}><h1 style={{ ...styles.title, fontSize: '22px' }}>üé® Settings</h1><p style={styles.subtitle}>Customize the app</p></header>
            {showCustomize && <CustomizeKidsModal users={users} onSave={(newUsers) => { onSaveUsers(newUsers); setShowCustomize(false); }} onCancel={() => setShowCustomize(false)} darkMode={darkMode} />}
            <div style={styles.card}><h3 style={{ margin: '0 0 16px 0', fontSize: '16px', fontWeight: '600' }}>Appearance</h3><button onClick={() => { haptic('medium'); onToggleDarkMode(); }} style={{ ...styles.button, width: '100%', background: darkMode ? '#4ECDC4' : '#2C3E50', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>{darkMode ? '‚òÄÔ∏è Switch to Light Mode' : 'üåô Switch to Dark Mode'}</button></div>
            <div style={styles.card}><h3 style={{ margin: '0 0 16px 0', fontSize: '16px', fontWeight: '600' }}>Kids</h3><div style={{ display: 'flex', gap: '8px', marginBottom: '16px', flexWrap: 'wrap' }}>{users.map(user => (<div key={user.name} style={{ background: `${user.color}22`, border: `2px solid ${user.color}`, borderRadius: '12px', padding: '8px 12px', display: 'flex', alignItems: 'center', gap: '6px' }}><span>{user.emoji}</span><span style={{ fontWeight: '600' }}>{user.name}</span></div>))}</div><button onClick={() => setShowCustomize(true)} style={{ ...styles.button, width: '100%', background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>‚úèÔ∏è Customize Kids</button></div>
          </div>
          <AppFooter darkMode={darkMode} />
          <nav style={styles.nav}>
            <button onClick={onLogout} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üè†</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Home</span></button>
            <button onClick={() => onNavigate('chores')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üìã</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Chores</span></button>
            <button onClick={() => onNavigate('history')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üìä</span><span style={{ fontSize: '11px', fontWeight: '600' }}>History</span></button>
            <button onClick={() => onNavigate('manage')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>‚öôÔ∏è</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Manage</span></button>
            <button style={{ ...styles.navBtn, color: '#45B7D1' }}><span style={{ fontSize: '20px' }}>üé®</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Settings</span></button>
          </nav>
        </div>
      );
    }

    function ManageView({ chores, users, onAddChore, onAddBulkChores, onDeleteChore, onNavigate, onLogout, templates, onSaveTemplate, onDeleteTemplate, onUpdateTemplate, darkMode }) {
      const styles = getStyles(darkMode);
      const [showForm, setShowForm] = useState(false);
      const [showTemplates, setShowTemplates] = useState(false);
      const [showMultiPicker, setShowMultiPicker] = useState(false);
      const [editingTemplateId, setEditingTemplateId] = useState(null);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [formData, setFormData] = useState({ type: 'mandatory', description: '', points: '', assignedTo: users[0]?.name, saveAsTemplate: false });
      // Batch assignment state
      const [batchSelected, setBatchSelected] = useState([]);
      const [showExclusionModal, setShowExclusionModal] = useState(false);
      const [showPreviewModal, setShowPreviewModal] = useState(false);
      const [batchAssignments, setBatchAssignments] = useState([]);
      const [batchOptional, setBatchOptional] = useState([]);
      const [excludedKids, setExcludedKids] = useState([]);
      const activeChores = chores.filter(c => c.status === 'active');
      const resetForm = () => { setFormData({ type: 'mandatory', description: '', points: '', assignedTo: users[0]?.name, saveAsTemplate: false }); setEditingTemplateId(null); };
      const handleDeleteConfirm = () => { haptic('medium'); if (deleteConfirm.type === 'chore') onDeleteChore(deleteConfirm.id); else if (deleteConfirm.type === 'template') onDeleteTemplate(deleteConfirm.id); setDeleteConfirm(null); };
      const loadTemplate = (template) => { setFormData({ type: template.type, description: template.description, points: template.points || '', assignedTo: template.assignedTo || users[0]?.name, saveAsTemplate: false }); setEditingTemplateId(template.id); setShowForm(true); setShowTemplates(false); };
      const handleSubmit = () => { if (!formData.description.trim()) return; haptic('success'); const choreData = { type: formData.type, description: formData.description, points: formData.type === 'optional' ? (parseInt(formData.points) || 0) : 0, assignedTo: formData.type === 'optional' ? null : formData.assignedTo }; onAddChore(choreData); if (formData.saveAsTemplate) { const templateData = { ...choreData, assignmentMode: formData.type === 'mandatory' ? 'random' : 'optional' }; if (editingTemplateId) onUpdateTemplate(editingTemplateId, templateData); else onSaveTemplate(templateData); } resetForm(); setShowForm(false); };
      const handleBulkAssign = (selectedUsers) => { if (!formData.description.trim() || selectedUsers.length === 0) return; haptic('success'); const choresData = selectedUsers.map(userName => ({ type: 'mandatory', description: formData.description, points: 0, assignedTo: userName })); onAddBulkChores(choresData); if (formData.saveAsTemplate) onSaveTemplate({ type: 'mandatory', description: formData.description, points: 0, assignedTo: null, assignmentMode: 'random' }); resetForm(); setShowForm(false); setShowMultiPicker(false); };
      const handleUpdateTemplateOnly = () => { if (!editingTemplateId || !formData.description.trim()) return; haptic('medium'); onUpdateTemplate(editingTemplateId, { type: formData.type, description: formData.description, points: formData.type === 'optional' ? (parseInt(formData.points) || 0) : 0, assignedTo: formData.type === 'optional' ? null : formData.assignedTo, assignmentMode: formData.type === 'mandatory' ? 'random' : 'optional' }); resetForm(); setShowForm(false); };
      const getUser = (name) => users.find(u => u.name === name);

      // Batch assignment functions
      const toggleBatchSelect = (templateId) => setBatchSelected(prev => prev.includes(templateId) ? prev.filter(id => id !== templateId) : [...prev, templateId]);
      const toggleTemplateMode = (template) => {
        const newMode = (template.assignmentMode || (template.type === 'mandatory' ? 'random' : 'optional')) === 'random' ? 'optional' : 'random';
        onUpdateTemplate(template.id, { ...template, assignmentMode: newMode });
      };
      const getTemplateMode = (template) => template.assignmentMode || (template.type === 'mandatory' ? 'random' : 'optional');

      const shuffleArray = (arr) => {
        const shuffled = [...arr];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      };

      const generateAssignments = (excludeList = []) => {
        const selectedTemplates = templates.filter(t => batchSelected.includes(t.id));
        const randomTemplates = selectedTemplates.filter(t => getTemplateMode(t) === 'random');
        const optionalTemplates = selectedTemplates.filter(t => getTemplateMode(t) === 'optional');
        const participatingKids = users.filter(u => !excludeList.includes(u.name));

        const shuffledKids = shuffleArray(participatingKids);
        const shuffledRandom = shuffleArray(randomTemplates);

        const assignments = shuffledRandom.map((template, i) => ({
          description: template.description,
          assignedTo: shuffledKids[i % shuffledKids.length].name
        }));

        const optional = optionalTemplates.map(t => ({
          description: t.description,
          points: t.points || 0
        }));

        setBatchAssignments(assignments);
        setBatchOptional(optional);
        setExcludedKids(excludeList);
        setShowPreviewModal(true);
        setShowExclusionModal(false);
      };

      const handleStartBatchAssign = () => {
        if (batchSelected.length === 0) return;
        const selectedTemplates = templates.filter(t => batchSelected.includes(t.id));
        const randomCount = selectedTemplates.filter(t => getTemplateMode(t) === 'random').length;

        if (randomCount > 0 && randomCount < users.length) {
          setShowExclusionModal(true);
        } else {
          generateAssignments([]);
        }
      };

      const handleConfirmBatch = () => {
        const newChores = [
          ...batchAssignments.map(a => ({
            type: 'mandatory',
            description: a.description,
            points: 0,
            assignedTo: a.assignedTo
          })),
          ...batchOptional.map(o => ({
            type: 'optional',
            description: o.description,
            points: o.points,
            assignedTo: null
          }))
        ];
        onAddBulkChores(newChores);
        setBatchSelected([]);
        setBatchAssignments([]);
        setBatchOptional([]);
        setShowPreviewModal(false);
        haptic('success');
      };
      return (
        <div style={{ ...styles.container, padding: '16px', paddingBottom: '100px', display: 'flex', flexDirection: 'column' }}>
          <AppHeader darkMode={darkMode} />
          {deleteConfirm && <ConfirmModal message={deleteConfirm.type === 'chore' ? 'Delete this chore?' : 'Delete this saved chore?'} onConfirm={handleDeleteConfirm} onCancel={() => setDeleteConfirm(null)} darkMode={darkMode} />}
          {showMultiPicker && <MultiUserPickerModal users={users} onConfirm={handleBulkAssign} onCancel={() => setShowMultiPicker(false)} darkMode={darkMode} />}
          {showExclusionModal && <KidExclusionModal users={users} excludeCount={users.length - templates.filter(t => batchSelected.includes(t.id) && getTemplateMode(t) === 'random').length} onConfirm={(excluded) => generateAssignments(excluded)} onCancel={() => setShowExclusionModal(false)} darkMode={darkMode} />}
          {showPreviewModal && <AssignmentPreviewModal assignments={batchAssignments} optionalChores={batchOptional} users={users} onShuffle={() => generateAssignments(excludedKids)} onConfirm={handleConfirmBatch} onCancel={() => setShowPreviewModal(false)} darkMode={darkMode} />}
          <div style={{ flex: 1 }}>
            <header style={{ marginBottom: '20px' }}><h1 style={{ ...styles.title, fontSize: '22px' }}>‚öôÔ∏è Manage Chores</h1><p style={styles.subtitle}>Add, edit, or remove chores</p></header>
          {!showForm && !showTemplates && (
            <div style={{ display: 'flex', gap: '12px', marginBottom: '20px' }}>
              <button onClick={() => { resetForm(); setShowForm(true); }} style={{ ...styles.button, flex: 1, background: '#45B7D1', color: 'white', padding: '16px' }}>+ Add New Chore</button>
              {templates.length > 0 && <button onClick={() => setShowTemplates(true)} style={{ ...styles.button, background: darkMode ? '#333' : '#2C3E50', color: 'white', padding: '16px' }}>üìÅ Saved ({templates.length})</button>}
            </div>
          )}
          {showTemplates && (
            <div style={{ ...styles.card, marginBottom: '20px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}><h3 style={{ margin: 0, fontSize: '18px', fontWeight: '700' }}>üìÅ Saved Chores</h3><button onClick={() => { setShowTemplates(false); setBatchSelected([]); }} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '20px', color: darkMode ? '#ccc' : '#666' }}>‚úï</button></div>

              <p style={{ fontSize: '13px', color: '#999', marginBottom: '12px' }}>Tap description to load as single chore</p>
              {templates.map(template => (
                <div key={template.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: darkMode ? '#2a2a3e' : '#f8f8f8', borderRadius: '10px', marginBottom: '8px', borderLeft: `4px solid ${template.type === 'mandatory' ? '#FF6B6B' : '#4ECDC4'}` }}>
                  <button onClick={() => loadTemplate(template)} style={{ background: 'none', border: 'none', cursor: 'pointer', textAlign: 'left', flex: 1, color: darkMode ? '#e0e0e0' : '#2C3E50' }}><div style={{ fontWeight: '600' }}>{template.description}</div><div style={{ fontSize: '12px', color: '#999', marginTop: '2px' }}>{template.type === 'mandatory' ? 'üìå Required' : `‚≠ê ${template.points || 0} pts`}</div></button>
                  <button onClick={() => setDeleteConfirm({ type: 'template', id: template.id })} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '16px', padding: '8px' }}>üóëÔ∏è</button>
                </div>
              ))}

              {templates.length > 0 && (
                <>
                  <div style={{ borderTop: darkMode ? '1px solid #333' : '1px solid #e0e0e0', margin: '20px 0', paddingTop: '20px' }}>
                    <h4 style={{ margin: '0 0 8px 0', fontSize: '16px', fontWeight: '700' }}>üé≤ Batch Assignment</h4>
                    <p style={{ fontSize: '13px', color: '#999', marginBottom: '12px' }}>Select chores below and generate random assignments</p>
                  </div>
                  {templates.map(template => {
                    const mode = getTemplateMode(template);
                    const isSelected = batchSelected.includes(template.id);
                    return (
                      <div key={`batch-${template.id}`} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '10px 12px', background: isSelected ? (darkMode ? '#333' : '#e8f4f8') : (darkMode ? '#2a2a3e' : '#f8f8f8'), borderRadius: '10px', marginBottom: '8px', border: isSelected ? '2px solid #45B7D1' : '2px solid transparent' }}>
                        <input type="checkbox" checked={isSelected} onChange={() => toggleBatchSelect(template.id)} style={{ width: '20px', height: '20px', cursor: 'pointer' }} />
                        <div style={{ flex: 1 }}>
                          <div style={{ fontWeight: '600', fontSize: '14px', color: darkMode ? '#e0e0e0' : '#2C3E50' }}>{template.description}</div>
                        </div>
                        {mode === 'optional' && (
                          <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <input type="number" value={template.points || 0} onChange={(e) => onUpdateTemplate(template.id, { ...template, points: parseInt(e.target.value) || 0 })} style={{ width: '50px', padding: '4px 6px', borderRadius: '6px', border: darkMode ? '1px solid #444' : '1px solid #ddd', background: darkMode ? '#1e1e2f' : 'white', color: '#FFE66D', fontWeight: '700', fontSize: '14px', textAlign: 'center' }} onClick={(e) => e.stopPropagation()} />
                            <span style={{ fontSize: '12px', color: '#FFE66D' }}>pts</span>
                          </div>
                        )}
                        <button onClick={() => { haptic('light'); toggleTemplateMode(template); }} style={{ ...styles.button, padding: '6px 12px', fontSize: '12px', background: mode === 'random' ? '#FF6B6B22' : '#4ECDC422', color: mode === 'random' ? '#FF6B6B' : '#4ECDC4', border: 'none' }}>
                          {mode === 'random' ? 'üé≤ Random' : '‚≠ê Optional'}
                        </button>
                      </div>
                    );
                  })}
                  {batchSelected.length > 0 && (
                    <button onClick={handleStartBatchAssign} style={{ ...styles.button, width: '100%', marginTop: '12px', background: '#45B7D1', color: 'white', padding: '14px' }}>
                      Generate Chores ({batchSelected.length} selected)
                    </button>
                  )}
                </>
              )}
            </div>
          )}
          {showForm && (
            <div style={{ ...styles.card, marginBottom: '20px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}><h3 style={{ margin: 0, fontSize: '18px', fontWeight: '700' }}>{editingTemplateId ? 'Edit & Add Chore' : 'New Chore'}</h3><button type="button" onClick={() => { setShowForm(false); resetForm(); }} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '20px', color: darkMode ? '#ccc' : '#666' }}>‚úï</button></div>
              <div style={{ marginBottom: '16px' }}><label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Type</label><div style={{ display: 'flex', gap: '12px' }}><button type="button" onClick={() => setFormData(f => ({ ...f, type: 'mandatory', points: '' }))} style={{ ...styles.button, flex: 1, background: formData.type === 'mandatory' ? '#FF6B6B' : (darkMode ? '#333' : '#FF6B6B20'), color: formData.type === 'mandatory' ? 'white' : '#FF6B6B' }}>üìå Required</button><button type="button" onClick={() => setFormData(f => ({ ...f, type: 'optional' }))} style={{ ...styles.button, flex: 1, background: formData.type === 'optional' ? '#4ECDC4' : (darkMode ? '#333' : '#4ECDC420'), color: formData.type === 'optional' ? 'white' : '#4ECDC4' }}>‚≠ê Optional</button></div></div>
              <div style={{ marginBottom: '16px' }}><label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Description</label><input type="text" value={formData.description} onChange={(e) => setFormData(f => ({ ...f, description: e.target.value }))} placeholder="e.g., Take out the trash" style={styles.input} autoFocus /></div>
              {formData.type === 'optional' && <div style={{ marginBottom: '16px' }}><label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Points</label><input type="number" value={formData.points} onChange={(e) => setFormData(f => ({ ...f, points: e.target.value }))} placeholder="0" style={styles.input} /></div>}
              {formData.type === 'mandatory' && <div style={{ marginBottom: '16px' }}><label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#999', marginBottom: '8px' }}>Assign To</label><select value={formData.assignedTo} onChange={(e) => setFormData(f => ({ ...f, assignedTo: e.target.value }))} style={{ ...styles.input, background: darkMode ? '#2a2a3e' : 'white' }}>{users.map(u => <option key={u.name} value={u.name}>{u.name}</option>)}</select></div>}
              <div style={{ marginBottom: '16px' }}><label style={{ display: 'flex', alignItems: 'center', gap: '10px', cursor: 'pointer' }}><input type="checkbox" checked={formData.saveAsTemplate} onChange={(e) => setFormData(f => ({ ...f, saveAsTemplate: e.target.checked }))} style={{ width: '18px', height: '18px' }} /><span style={{ fontSize: '14px' }}>{editingTemplateId ? 'Update saved chore' : 'Save as frequent chore'}</span></label></div>
              <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                <button type="button" onClick={() => { setShowForm(false); resetForm(); }} style={{ ...styles.button, flex: '1 1 100px', background: darkMode ? '#333' : '#f0f0f0', color: darkMode ? '#ccc' : '#666' }}>Cancel</button>
                {editingTemplateId && <button type="button" onClick={handleUpdateTemplateOnly} style={{ ...styles.button, background: '#9B59B6', color: 'white', fontSize: '14px', padding: '12px 16px' }}>Save Only</button>}
                {formData.type === 'mandatory' && <button type="button" onClick={() => setShowMultiPicker(true)} disabled={!formData.description.trim()} style={{ ...styles.button, background: '#FFE66D', color: '#2C3E50', fontSize: '14px', padding: '12px 16px' }}>üë• Multiple</button>}
                <button type="button" onClick={handleSubmit} style={{ ...styles.button, flex: '1 1 100px', background: darkMode ? '#4ECDC4' : '#2C3E50', color: 'white' }}>Add Chore</button>
              </div>
            </div>
          )}
          <section>
            <h2 style={{ fontSize: '16px', fontWeight: '600', marginBottom: '12px' }}>Active Chores ({activeChores.length})</h2>
            {activeChores.length > 0 ? activeChores.map(chore => { const user = getUser(chore.assignedTo); return (
              <div key={chore.id} style={{ ...styles.card, borderLeft: `4px solid ${chore.type === 'mandatory' ? '#FF6B6B' : '#4ECDC4'}`, marginBottom: '12px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                  <div><div style={{ display: 'flex', gap: '8px', marginBottom: '8px', flexWrap: 'wrap' }}><span style={{ ...styles.tag, background: chore.type === 'mandatory' ? '#FF6B6B20' : '#4ECDC420', color: chore.type === 'mandatory' ? '#FF6B6B' : '#4ECDC4' }}>{chore.type === 'mandatory' ? 'üìå Required' : '‚≠ê Optional'}</span>{user && <span style={{ ...styles.tag, background: `${user.color}22`, color: user.color }}>{user.emoji} {user.name}</span>}</div><div style={{ fontWeight: '600' }}>{chore.description}</div>{chore.points > 0 && <div style={{ fontSize: '13px', color: '#999', marginTop: '4px' }}>{chore.points} points</div>}</div>
                  <button onClick={() => setDeleteConfirm({ type: 'chore', id: chore.id })} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: '18px', padding: '8px' }}>üóëÔ∏è</button>
                </div>
              </div>
            ); }) : <div style={{ textAlign: 'center', padding: '40px 20px', color: '#999' }}>No active chores. Add one above!</div>}
          </section>
          </div>
          <AppFooter darkMode={darkMode} />
          <nav style={styles.nav}>
            <button onClick={onLogout} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üè†</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Home</span></button>
            <button onClick={() => onNavigate('chores')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üìã</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Chores</span></button>
            <button onClick={() => onNavigate('history')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üìä</span><span style={{ fontSize: '11px', fontWeight: '600' }}>History</span></button>
            <button style={{ ...styles.navBtn, color: '#45B7D1' }}><span style={{ fontSize: '20px' }}>‚öôÔ∏è</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Manage</span></button>
            <button onClick={() => onNavigate('settings')} style={{ ...styles.navBtn, color: '#999' }}><span style={{ fontSize: '20px' }}>üé®</span><span style={{ fontSize: '11px', fontWeight: '600' }}>Settings</span></button>
          </nav>
        </div>
      );
    }

    // Error Boundary for crash recovery
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error('App Error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          const dark = localStorage.getItem('darkMode') === 'true';
          return (
            <div style={{
              minHeight: '100vh',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              background: dark ? '#1a1a2e' : '#f5f5f5',
              padding: '20px',
              fontFamily: "'Segoe UI', system-ui, sans-serif"
            }}>
              <div style={{
                background: dark ? '#1e1e2f' : 'white',
                borderRadius: '20px',
                padding: '32px',
                maxWidth: '400px',
                textAlign: 'center',
                boxShadow: '0 4px 20px rgba(0,0,0,0.15)'
              }}>
                <div style={{ fontSize: '48px', marginBottom: '16px' }}>üòµ</div>
                <h1 style={{ fontSize: '20px', fontWeight: '700', color: dark ? '#e0e0e0' : '#2C3E50', marginBottom: '12px' }}>
                  Oops! Something went wrong
                </h1>
                <p style={{ color: dark ? '#888' : '#666', marginBottom: '24px', fontSize: '14px' }}>
                  The app encountered an unexpected error. Try refreshing the page.
                </p>
                <button
                  onClick={() => window.location.reload()}
                  style={{
                    background: '#45B7D1',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    padding: '12px 32px',
                    fontSize: '16px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  Refresh Page
                </button>
              </div>
            </div>
          );
        }
        return this.props.children;
      }
    }

    function App() {
      const [currentUser, setCurrentUser] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [showPinEntry, setShowPinEntry] = useState(false);
      const [view, setView] = useState('chores');
      const [weekOffset, setWeekOffset] = useState(0);
      const [editingChore, setEditingChore] = useState(null);
      const [undoCompletion, setUndoCompletion] = useState(null);
      const [loading, setLoading] = useState(true);
      const [chores, setChores] = useState([]);
      const [completions, setCompletions] = useState([]);
      const [templates, setTemplates] = useState([]);
      const [users, setUsers] = useState(DEFAULT_USERS);
      const [darkMode, setDarkMode] = useState(() => storage.get('darkMode', false));

      useEffect(() => {
        const loadData = async () => {
          setLoading(true);
          const data = await api.getAll();
          console.log('Loaded data:', data);
          if (data) {
            if (data.chores && Array.isArray(data.chores)) setChores(data.chores);
            if (data.completions && Array.isArray(data.completions)) setCompletions(data.completions);
            if (data.templates && Array.isArray(data.templates)) setTemplates(data.templates);
            if (data.users && Array.isArray(data.users) && data.users.length > 0) setUsers(data.users);
          }
          setLoading(false);
        };
        loadData();
      }, []);

      useEffect(() => { storage.set('darkMode', darkMode); }, [darkMode]);

      const handleUserSelect = (user) => { if (user === 'admin') setShowPinEntry(true); else { setCurrentUser(user); setIsAdmin(false); } };
      const handlePinSuccess = () => { setShowPinEntry(false); setCurrentUser('Admin'); setIsAdmin(true); };
      const handleLogout = () => { setCurrentUser(null); setIsAdmin(false); setView('chores'); setWeekOffset(0); };
      
      const handleComplete = async (chore, completedBy) => {
        const completion = { id: generateId(), choreId: chore.id, description: chore.description, points: completedBy === null ? 0 : (chore.points || 0), completedBy: completedBy === null ? 'Parent' : completedBy, completedAt: new Date().toISOString() };
        const updatedChore = { ...chore, status: 'completed' };
        setCompletions(prev => [...prev, completion]);
        setChores(prev => prev.map(c => c.id === chore.id ? updatedChore : c));
        setUndoCompletion({ completion, chore });
        haptic('success');
        await api.addCompletion(completion);
        await api.updateChore(updatedChore);
      };

      const handleUndo = async (completion) => {
        const originalChore = chores.find(c => c.id === completion.choreId);
        if (originalChore) {
          const restoredChore = { ...originalChore, status: 'active' };
          setChores(prev => prev.map(c => c.id === completion.choreId ? restoredChore : c));
          await api.updateChore(restoredChore);
        }
        setCompletions(prev => prev.filter(c => c.id !== completion.id));
        await api.deleteCompletion(completion.id);
        setUndoCompletion(null);
        haptic('medium');
      };

      const handleUndoFromToast = async () => {
        if (undoCompletion) {
          const restoredChore = { ...undoCompletion.chore, status: 'active' };
          setChores(prev => prev.map(c => c.id === undoCompletion.chore.id ? restoredChore : c));
          setCompletions(prev => prev.filter(c => c.id !== undoCompletion.completion.id));
          await api.updateChore(restoredChore);
          await api.deleteCompletion(undoCompletion.completion.id);
          setUndoCompletion(null);
          haptic('medium');
        }
      };
      
      const handleEditChore = (chore) => setEditingChore(chore);
      
      const handleSaveEdit = async (updatedChore) => { 
        setChores(prev => prev.map(c => c.id === updatedChore.id ? updatedChore : c)); 
        setEditingChore(null); 
        haptic('success');
        await api.updateChore(updatedChore);
      };
      
      const handleAddChore = async (choreData) => {
        const newChore = { id: generateId(), ...choreData, status: 'active', createdAt: new Date().toISOString() };
        setChores(prev => [...prev, newChore]);
        await api.addChore(newChore);
      };
      
      const handleAddBulkChores = async (choresData) => {
        const newChores = choresData.map(data => ({ id: generateId(), ...data, status: 'active', createdAt: new Date().toISOString() }));
        setChores(prev => [...prev, ...newChores]);
        await api.addChores(newChores);
      };
      
      const handleDeleteChore = async (choreId) => {
        setChores(prev => prev.filter(c => c.id !== choreId));
        await api.deleteChore(choreId);
      };
      
      const handleSaveTemplate = async (templateData) => {
        const newTemplate = { id: generateId(), ...templateData };
        setTemplates(prev => [...prev, newTemplate]);
        await api.addTemplate(newTemplate);
      };
      
      const handleDeleteTemplate = async (templateId) => {
        setTemplates(prev => prev.filter(t => t.id !== templateId));
        await api.deleteTemplate(templateId);
      };
      
      const handleUpdateTemplate = async (templateId, templateData) => {
        const updatedTemplate = { id: templateId, ...templateData };
        setTemplates(prev => prev.map(t => t.id === templateId ? updatedTemplate : t));
        await api.updateTemplate(updatedTemplate);
      };

      const handleSaveUsers = async (newUsers) => {
        setUsers(newUsers);
        const success = await api.updateUsers(newUsers);
        if (!success) {
          console.warn('Failed to save users, reloading from database...');
          const data = await api.getAll();
          if (data?.users?.length > 0) setUsers(data.users);
        }
      };

      const handleSaveUser = async (updatedUser) => {
        const newUsers = users.map(u => u.name === updatedUser.name ? updatedUser : u);
        setUsers(newUsers);
        const success = await api.updateUsers(newUsers);
        if (!success) {
          console.warn('Failed to save user, reloading from database...');
          const data = await api.getAll();
          if (data?.users?.length > 0) setUsers(data.users);
        }
      };

      const styles = getStyles(darkMode);

      if (loading) {
        return (
          <div style={{ ...styles.container, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
            <div style={{ textAlign: 'center' }}>
              <img src="icon.svg" alt="Logo" style={{ width: '64px', height: '64px', marginBottom: '16px' }} />
              <p style={{ color: darkMode ? '#888' : '#999' }}>Loading...</p>
            </div>
          </div>
        );
      }

      if (!currentUser && !showPinEntry) return <UserSelect onSelect={handleUserSelect} users={users} completions={completions} darkMode={darkMode} />;
      if (showPinEntry) return <EmojiPattern onSuccess={handlePinSuccess} onCancel={() => setShowPinEntry(false)} darkMode={darkMode} />;

      return (
        <>
          {editingChore && <EditChoreModal chore={editingChore} users={users} onSave={handleSaveEdit} onCancel={() => setEditingChore(null)} darkMode={darkMode} />}
          {undoCompletion && view === 'chores' && <UndoToast completion={undoCompletion.completion} onUndo={handleUndoFromToast} onDismiss={() => setUndoCompletion(null)} darkMode={darkMode} />}
          {view === 'history' && <HistoryView completions={completions} users={users} onNavigate={setView} onUndo={handleUndo} onLogout={handleLogout} isAdmin={isAdmin} darkMode={darkMode} weekOffset={weekOffset} onWeekChange={setWeekOffset} />}
          {view === 'manage' && isAdmin && <ManageView chores={chores} users={users} onAddChore={handleAddChore} onAddBulkChores={handleAddBulkChores} onDeleteChore={handleDeleteChore} onNavigate={setView} onLogout={handleLogout} templates={templates} onSaveTemplate={handleSaveTemplate} onDeleteTemplate={handleDeleteTemplate} onUpdateTemplate={handleUpdateTemplate} darkMode={darkMode} />}
          {view === 'settings' && isAdmin && <SettingsView users={users} onSaveUsers={handleSaveUsers} darkMode={darkMode} onToggleDarkMode={() => setDarkMode(d => !d)} onNavigate={setView} onLogout={handleLogout} />}
          {view === 'chores' && <ChoreView currentUser={currentUser} isAdmin={isAdmin} chores={chores} completions={completions} users={users} onComplete={handleComplete} onEdit={handleEditChore} onNavigate={setView} onLogout={handleLogout} onSaveUser={handleSaveUser} darkMode={darkMode} weekOffset={weekOffset} onWeekChange={setWeekOffset} />}
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ErrorBoundary><App /></ErrorBoundary>);
  </script>
</body>
</html>
